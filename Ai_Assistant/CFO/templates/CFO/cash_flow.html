{% extends "CFO/base.html" %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<div class="container py-5">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Cash Flow Analysis</h2>
    <a href="{% url 'CFO:export_center' %}" class="btn btn-outline-primary">
      <i class="bi bi-download"></i> Export Report
    </a>
  </div>

  <!-- Key Metrics -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <h6>Cash Inflows</h6>
        <h4 class="fw-bold text-success">₹{{ cash_inflows|default_if_none:0 }}</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <h6>Cash Outflows</h6>
        <h4 class="fw-bold text-danger">₹{{ cash_outflows|default_if_none:0 }}</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm text-center p-3">
        <h6>Net Cash Flow</h6>
        <h4 class="fw-bold text-primary">₹{{ net_cash_flow|default_if_none:0 }}</h4>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6 class="fw-bold">Cash Inflows vs Outflows</h6>
        <canvas id="cashFlowBarChart" style="height: 300px;"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6 class="fw-bold">Net Cash Flow Trend</h6>
        <canvas id="netCashFlowLineChart" style="height: 300px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Safely pass Django context to JS
    const months = {{ months|default:"[]" }};
    const netCashFlowTrend = {{ net_cash_flow_trend|default:"[]" }};

    const cashInflows = Number({{ cash_inflows|default_if_none:0 }});
    const cashOutflows = Number({{ cash_outflows|default_if_none:0 }});

    // Cash Inflows vs Outflows Chart
    new Chart(document.getElementById('cashFlowBarChart'), {
        type: 'bar',
        data: {
            labels: ['Cash Inflows', 'Cash Outflows'],
            datasets: [{
                label: 'Amount (₹)',
                data: [cashInflows, cashOutflows],
                backgroundColor: ['#198754', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Net Cash Flow Trend Chart
    new Chart(document.getElementById('netCashFlowLineChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Net Cash Flow (₹)',
                data: netCashFlowTrend,
                borderColor: '#0d6efd',
                borderWidth: 2,
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true } }
        }
    });
});
</script>
{% endblock %}
